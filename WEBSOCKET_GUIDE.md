# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ WebSocket –≤ TailTrail

## üöÄ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–∏—á–∞

**–¢–µ–ø–µ—Ä—å —Ç–µ–±–µ –ù–ï –ù–£–ñ–ù–û –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –∫–∞–∂–¥–æ–º—É —á–∞—Ç—É –æ—Ç–¥–µ–ª—å–Ω–æ!**

–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ WebSocket —Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—à—å—Å—è –Ω–∞ **–í–°–ï —Å–≤–æ–∏ —á–∞—Ç—ã** –∏ –ø–æ–ª—É—á–∞–µ—à—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ –≤—Å–µ—Ö —Å—Ä–∞–∑—É.

## üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```
ws://localhost:8000/websocket/ws/{user_id}
```

## üîÑ –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:

1. ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
2. üîç –ü–æ–∏—Å–∫ –≤—Å–µ—Ö —Ç–≤–æ–∏—Ö —á–∞—Ç–æ–≤ –≤ –ë–î
3. üîó –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å–µ —á–∞—Ç—ã
4. üì¨ –¢—ã —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ—à—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ –í–°–ï–• —á–∞—Ç–æ–≤

## üì® –í—Ö–æ–¥—è—â–∏–µ —Å–æ–±—ã—Ç–∏—è (—á—Ç–æ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å):

### –°–æ–æ–±—â–µ–Ω–∏—è
- `new_message` - –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª—é–±–æ–º –∏–∑ —Ç–≤–æ–∏—Ö —á–∞—Ç–æ–≤
- `messages_read` - –∫—Ç–æ-—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è

### –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
- `user_typing` - –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç
- `user_stopped_typing` - –ø–µ—Ä–µ—Å—Ç–∞–ª –ø–µ—á–∞—Ç–∞—Ç—å
- `user_joined` - –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É
- `user_left` - –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç

### –°–∏—Å—Ç–µ–º–Ω—ã–µ
- `global_notification` - –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `my_chats` - —Å–ø–∏—Å–æ–∫ —Ç–≤–æ–∏—Ö —á–∞—Ç–æ–≤
- `chat_status` - —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —á–∞—Ç–æ–≤
- `error` - –æ—à–∏–±–∫–∏

## üì§ –ò—Å—Ö–æ–¥—è—â–∏–µ –∫–æ–º–∞–Ω–¥—ã (—á—Ç–æ —Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å):

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏
```json
{
    "type": "get_my_chats",
    "data": {}
}
```

```json
{
    "type": "get_chat_status", 
    "data": {}
}
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```json
{
    "type": "send_message",
    "data": {
        "chat_id": "uuid-—á–∞—Ç–∞",
        "content": "—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"
    }
}
```

### –°—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç"
```json
{
    "type": "typing",
    "data": {
        "chat_id": "uuid-—á–∞—Ç–∞",
        "is_typing": true
    }
}
```

### –ü–æ–º–µ—Ç–∫–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
```json
{
    "type": "mark_read",
    "data": {
        "chat_id": "uuid-—á–∞—Ç–∞"
    }
}
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
```json
{
    "type": "join_chat",
    "data": {
        "chat_id": "uuid-—á–∞—Ç–∞"
    }
}
```

```json
{
    "type": "leave_chat",
    "data": {
        "chat_id": "uuid-—á–∞—Ç–∞"
    }
}
```

## üéØ –ö–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### JavaScript –ø—Ä–∏–º–µ—Ä:
```javascript
const ws = new WebSocket(`ws://localhost:8000/websocket/ws/${userId}`);

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
ws.onmessage = function(event) {
    const message = JSON.parse(event.data);
    
    switch(message.type) {
        case 'new_message':
            // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –õ–Æ–ë–û–ì–û —á–∞—Ç–∞
            console.log(`üì® –°–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ ${message.data.chat_id}`);
            console.log(`–û—Ç: ${message.data.sender.email}`);
            console.log(`–¢–µ–∫—Å—Ç: ${message.data.content}`);
            showNotification(message.data);
            break;
            
        case 'user_typing':
            showTypingIndicator(message.data.user_id);
            break;
            
        case 'my_chats':
            // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–≤–æ–∏—Ö —á–∞—Ç–æ–≤ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            message.data.chats.forEach(chat => {
                updateChatUI(chat);
            });
            break;
    }
};

// –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
ws.onopen = function() {
    console.log('üöÄ –ü–æ–¥–∫–ª—é—á–µ–Ω! –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –≤—Å–µ —á–∞—Ç—ã');
    
    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
    setTimeout(() => {
        ws.send(JSON.stringify({
            type: 'get_my_chats',
            data: {}
        }));
    }, 1000);
};
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç:

```bash
python websocket_test_client.py
```

–ò–∑–º–µ–Ω–∏ `user_id` –≤ —Ñ–∞–π–ª–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID.

## üõ† –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ –∫–æ–¥–∞:

```python
from src.websocket_manager import websocket_manager

# –£–≤–µ–¥–æ–º–∏—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞
await websocket_manager.notify_chat_participants(
    chat_id=chat_id,
    notification={
        "type": "system_message",
        "message": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–∏–ª –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞"
    }
)

# –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
await websocket_manager.send_global_notification(
    user_id=user_id,
    notification={
        "type": "account_warning",
        "message": "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"
    }
)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞:

```python
# –ö—Ç–æ —Å–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω
online_users = websocket_manager.get_online_users()

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω?
is_online = websocket_manager.is_user_online(user_id)

# –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_chats = websocket_manager.get_user_chats_list(user_id)
```

## üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:

‚úÖ **–û–¥–∏–Ω WebSocket = –≤—Å–µ —á–∞—Ç—ã**  
‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ –≤—Å–µ—Ö —á–∞—Ç–æ–≤**  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å–∫–∞**  
‚úÖ **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç" –≤–µ–∑–¥–µ**  
‚úÖ **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**  
‚úÖ **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

## üî• –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

**–†–∞–Ω—å—à–µ:**
- –ü–æ–¥–∫–ª—é—á–∞–µ—à—å—Å—è –∫ WebSocket
- –í—Ä—É—á–Ω—É—é –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—à—å—Å—è –Ω–∞ –∫–∞–∂–¥—ã–π —á–∞—Ç: `join_chat`
- –ü–æ–ª—É—á–∞–µ—à—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∏–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤

**–°–µ–π—á–∞—Å:**  
- –ü–æ–¥–∫–ª—é—á–∞–µ—à—å—Å—è –∫ WebSocket
- üéâ **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò** –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—à—å—Å—è –Ω–∞ –í–°–ï —á–∞—Ç—ã
- –ü–æ–ª—É—á–∞–µ—à—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ –í–°–ï–• —á–∞—Ç–æ–≤ —Å—Ä–∞–∑—É! 